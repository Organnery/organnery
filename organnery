#!/usr/bin/env bash

# load default configuration file & attempt to load user configuration file from USB
source /etc/organnery/organnery.conf
if [ -f $HOME/stops/organnery.conf ]; then
	source $HOME/stops/organnery.conf
fi

# set a sane default
if [ ! -f "$ORGANNERY_MIDIDINGS_SCRIPT" ]; then
	ORGANNERY_MIDIDINGS_SCRIPT="/usr/share/organnery/configs/passthru.py"
fi

# disconnect all midi connections
aconnect -x

# kill previous incarnation of software
killall --wait aeolus
killall --wait mididings

# find hardware midi ports
cards_in=$(aconnect -i | grep type=kernel,card | awk -F[\ ,:] '{print $2}')
cards_out=$(aconnect -o | grep type=kernel,card | awk -F[\ ,:] '{print $2}')

# start aeolus
HOME=$HOME/stops aeolus -u -S stops -A -d $ALSA_DEVICE -r $SAMPLE_RATE -p $PERIOD_SIZE -n $NUMBER_OF_FRAGMENTS &
AEOLUS_PID=$!

# start mididings input script
mididings -f "$ORGANNERY_MIDIDINGS_SCRIPT" &

# todo: wait for mididings & aeolus midi ports to come up
sleep 2

# connect each hardware midi input to mididings input
for card_out in $cards_out; do
	aconnect "$card_out" mididings:0
done

# connect mididings out to aeolus in
aconnect mididings:1 aeolus:In

# connect aeolus out to each midi hardware output
for card_in in $cards_in; do
	aconnect aeolus:1 "$card_in"
done

# wait for aeolus to quit
wait $AEOLUS_PID

# restart script
/usr/share/organnery/organnery
