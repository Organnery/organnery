#!/usr/bin/env bash

# kill previous
killall --wait aeolus

# disconnect midi connections
aconnect -x

# find hardware midi ports
cards_in=$(aconnect -i | grep type=kernel,card | awk -F[\ ,:] '{print $2}')
cards_out=$(aconnect -o | grep type=kernel,card | awk -F[\ ,:] '{print $2}')

# start aeolus
HOME=$HOME/stops aeolus -u -S stops -A &
pid=$!

# connect each card out to aeolus in
for card_out in $cards_out; do
    while ! aconnect "$card_out" aeolus:0; do sleep 1; done
done

# connect aeolus out to each card in
for card_in in $cards_in; do
    aconnect aeolus:1 "$card_in"
done

# wait for aeolus to quit
wait $!

# restart script
/usr/share/organnery/organnery
